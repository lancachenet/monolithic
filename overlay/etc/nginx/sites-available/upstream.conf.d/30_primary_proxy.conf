  # Proxy all requests to upstream
  location / {
    # Enable HTTP/1.1 and keepalive for supported upstreams
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Proxy using upstream pools (falls back to $host if not mapped)
    proxy_pass http://$upstream_name$request_uri;

    # Catch the errors to process the redirects
    proxy_intercept_errors on;
    error_page 301 302 307 = @upstream_redirect;
  }
